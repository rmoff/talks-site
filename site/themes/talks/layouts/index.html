{{ define "main" }}
{{ $notistTalks := where .Site.RegularPages ".Params.notist_id" "!=" nil }}
{{ $speakerdeckTalks := where .Site.RegularPages ".Params.speakerdeck_slug" "!=" nil }}
{{ $allTalks := $notistTalks | append $speakerdeckTalks }}
{{ $talks := $allTalks.ByParam "date" }}
{{ $recentTalk := index ($talks.Reverse) 0 }}

{{ $heroWebP := "" }}
{{ with $recentTalk.Params.image }}{{ $heroWebP = replaceRE "\\.[^.]+$" ".webp" . }}{{ end }}
<div class="hero-section" {{ with $heroWebP }}style="background-image: url('{{ . }}');"{{ end }}>
    <div class="hero-overlay">
        <div class="hero-content">
            <img src="https://on.notist.cloud/profile/pr-rmoff-large-0631f268c74370c9.jpg" alt="Robin Moffatt" class="hero-avatar">
            <div class="hero-text">
                <h1 class="hero-tagline">Robin Moffatt</h1>
                <p class="hero-bio">Principal DevEx Engineer speaking at conferences since 2010 including QCon, Devoxx, and Kafka Summit.</p>
                <nav class="hero-nav">
                    <a href="https://rmoff.net" target="_blank" title="Blog: rmoff.net"><i class="fas fa-house"></i></a>
                    <a href="https://youtube.com/rmoff" target="_blank" title="YouTube: youtube.com/rmoff"><i class="fab fa-youtube"></i></a>
                    {{ with .Site.Params.twitter }}<a href="https://twitter.com/{{ . }}" target="_blank" title="Twitter: @{{ . }}"><i class="fab fa-twitter"></i></a>{{ end }}
                    <a href="https://bsky.app/profile/rmoff.net" target="_blank" title="Bluesky: @rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
                    <a href="https://www.linkedin.com/in/robinmoffatt" target="_blank" title="LinkedIn: robinmoffatt"><i class="fab fa-linkedin"></i></a>
                    {{ with .Site.Params.github }}<a href="https://github.com/{{ . }}" target="_blank" title="GitHub: {{ . }}"><i class="fab fa-github"></i></a>{{ end }}
                </nav>
            </div>
        </div>
    </div>
</div>

{{ $years := slice }}
{{ range $talks.Reverse }}
    {{ $year := dateFormat "2006" .Params.date }}
    {{ if not (in $years $year) }}
        {{ $years = $years | append $year }}
    {{ end }}
{{ end }}
{{ $years = sort $years "value" "desc" }}

<nav class="year-nav">
    <div class="year-nav-inner">
        {{ range $years }}
        <a href="#year-{{ . }}" class="year-nav-link">{{ . }}</a>
        {{ end }}
    </div>
</nav>

<div class="talks-grid-container">
    <div class="talks-grid">
        {{ $allTalksReversed := $talks.Reverse }}
        {{ $totalTalks := len $allTalksReversed }}
        {{ range $index, $talk := $allTalksReversed }}
            {{ $year := dateFormat "2006" $talk.Params.date }}
            {{/* Check if this is first of year */}}
            {{ $isFirstOfYear := true }}
            {{ if gt $index 0 }}
                {{ $prevTalk := index $allTalksReversed (sub $index 1) }}
                {{ $prevYear := dateFormat "2006" $prevTalk.Params.date }}
                {{ $isFirstOfYear = ne $year $prevYear }}
            {{ end }}
            {{/* Check if this is last of year */}}
            {{ $isLastOfYear := true }}
            {{ $nextIndex := add $index 1 }}
            {{ if lt $nextIndex $totalTalks }}
                {{ $nextTalk := index $allTalksReversed $nextIndex }}
                {{ $nextYear := dateFormat "2006" $nextTalk.Params.date }}
                {{ $isLastOfYear = ne $year $nextYear }}
            {{ end }}
            {{ $cardClass := "talk-card" }}
            {{ if $isFirstOfYear }}{{ $cardClass = printf "%s year-first" $cardClass }}{{ end }}
            {{ if $isLastOfYear }}{{ $cardClass = printf "%s year-last" $cardClass }}{{ end }}
            <article class="{{ $cardClass }}" {{ if $isFirstOfYear }}id="year-{{ $year }}"{{ end }}>
                {{ if $isFirstOfYear }}
                <div class="year-badge">// {{ $year }}</div>
                {{ end }}
                <a href="{{ $talk.RelPermalink }}" class="talk-link">
                    {{ with $talk.Params.image }}
                    <div class="talk-thumbnail-wrapper">
                        {{ partial "responsive-image.html" (dict "src" . "alt" $talk.Title "sizes" "(max-width: 480px) 100vw, (max-width: 900px) 50vw, 400px") }}
                        {{ with $talk.Params.event }}
                        <div class="talk-meta-box">
                            <div class="talk-event">{{ . }}</div>
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}
                    <div class="talk-info">
                        <h3 class="talk-title">{{ $talk.Title }}</h3>
                    </div>
                </a>
            </article>
        {{ end }}
    </div>
</div>

<script>
(function() {
    const yearNav = document.querySelector('.year-nav-inner');
    const yearCards = Array.from(document.querySelectorAll('article[id^="year-"]'));

    // Group years by row position and rebuild nav
    function buildNav() {
        if (!yearNav || yearCards.length === 0) return;

        // Get positions of all year cards
        const yearPositions = yearCards.map(card => ({
            year: card.id.replace('year-', ''),
            top: card.getBoundingClientRect().top + window.scrollY,
            card: card
        }));

        // Group years by row (within 50px tolerance)
        const groups = [];
        let currentGroup = null;

        yearPositions.forEach(item => {
            if (!currentGroup || Math.abs(item.top - currentGroup.top) > 50) {
                currentGroup = { top: item.top, years: [item.year], cards: [item.card] };
                groups.push(currentGroup);
            } else {
                currentGroup.years.push(item.year);
                currentGroup.cards.push(item.card);
            }
        });

        // Rebuild nav with grouped years
        yearNav.innerHTML = '';
        groups.forEach(group => {
            const link = document.createElement('a');
            link.className = 'year-nav-link';
            link.href = '#year-' + group.years[0];

            if (group.years.length > 1) {
                // Show range: first-last (abbreviated)
                const first = group.years[0];
                const last = group.years[group.years.length - 1];
                link.textContent = first + '-' + last.slice(-2);
            } else {
                link.textContent = group.years[0];
            }

            link.dataset.years = group.years.join(',');
            yearNav.appendChild(link);
        });
    }

    function updateActiveYear() {
        const yearLinks = document.querySelectorAll('.year-nav-link');
        const scrollPos = window.scrollY + 100;
        let activeLink = null;

        yearCards.forEach(card => {
            const rect = card.getBoundingClientRect();
            const top = rect.top + window.scrollY;
            if (scrollPos >= top - 50) {
                const year = card.id.replace('year-', '');
                // Find link that contains this year
                yearLinks.forEach(link => {
                    const years = link.dataset.years ? link.dataset.years.split(',') : [];
                    if (years.includes(year)) {
                        activeLink = link;
                    }
                });
            }
        });

        yearLinks.forEach(link => link.classList.remove('active'));
        if (activeLink) {
            activeLink.classList.add('active');
        } else if (yearLinks.length > 0) {
            yearLinks[0].classList.add('active');
        }
    }

    // Build nav after layout is complete
    window.addEventListener('load', () => {
        buildNav();
        updateActiveYear();
    });

    window.addEventListener('scroll', updateActiveYear);
    window.addEventListener('resize', () => {
        buildNav();
        updateActiveYear();
    });
})();
</script>
{{ end }}

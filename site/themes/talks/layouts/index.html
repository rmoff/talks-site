{{ define "main" }}
{{ $allTalks := where .Site.RegularPages ".Params.notist_id" "!=" nil }}
{{ $talks := $allTalks.ByParam "date" }}
{{ $recentTalk := index ($talks.Reverse) 0 }}

<div class="hero-section" {{ with $recentTalk.Params.image }}style="background-image: url('{{ . }}');"{{ end }}>
    <div class="hero-overlay">
        <div class="hero-content">
            <img src="https://on.notist.cloud/profile/pr-rmoff-large-0631f268c74370c9.jpg" alt="Robin Moffatt" class="hero-avatar">
            <div class="hero-text">
                <h1 class="hero-tagline">Robin Moffatt</h1>
                <p class="hero-bio">Principal DevEx Engineer speaking at conferences since 2009 including QCon, Devoxx, and Kafka Summit.</p>
                <nav class="hero-nav">
                    <a href="https://rmoff.net" target="_blank" title="Blog: rmoff.net"><i class="fas fa-house"></i></a>
                    <a href="https://youtube.com/rmoff" target="_blank" title="YouTube: youtube.com/rmoff"><i class="fab fa-youtube"></i></a>
                    {{ with .Site.Params.twitter }}<a href="https://twitter.com/{{ . }}" target="_blank" title="Twitter: @{{ . }}"><i class="fab fa-twitter"></i></a>{{ end }}
                    <a href="https://bsky.app/profile/rmoff.net" target="_blank" title="Bluesky: @rmoff.net"><i class="fa-brands fa-bluesky"></i></a>
                    <a href="https://www.linkedin.com/in/robinmoffatt" target="_blank" title="LinkedIn: robinmoffatt"><i class="fab fa-linkedin"></i></a>
                    {{ with .Site.Params.github }}<a href="https://github.com/{{ . }}" target="_blank" title="GitHub: {{ . }}"><i class="fab fa-github"></i></a>{{ end }}
                </nav>
            </div>
        </div>
    </div>
</div>

{{ $talksByYear := dict }}
{{ $years := slice }}

{{ range $talks.Reverse }}
    {{ $year := dateFormat "2006" .Params.date }}
    {{ $yearTalks := index $talksByYear $year }}
    {{ if not $yearTalks }}
        {{ $yearTalks = slice }}
        {{ $years = $years | append $year }}
    {{ end }}
    {{ $yearTalks = $yearTalks | append . }}
    {{ $talksByYear = merge $talksByYear (dict $year $yearTalks) }}
{{ end }}

{{ $years = sort $years "value" "desc" }}

<nav class="year-nav">
    <div class="year-nav-inner">
        {{ range $years }}
        <a href="#year-{{ . }}" class="year-nav-link">{{ . }}</a>
        {{ end }}
    </div>
</nav>

<div class="talks-by-year">

    {{ range $years }}
        {{ $year := . }}
        {{ $talks := index $talksByYear $year }}
    <section class="year-section" id="year-{{ $year }}">
        <h2 class="year-title">{{ $year }}</h2>
        <div class="year-grid">
            {{ range $index, $talk := $talks }}
                {{ $pattern := mod $index 5 }}
                {{ $sizeClass := "" }}

                {{ if eq $pattern 0 }}
                    {{ $sizeClass = "primary" }}
                {{ else }}
                    {{ $sizeClass = "secondary" }}
                {{ end }}

                <article class="talk-card {{ $sizeClass }}">
                    <a href="{{ .RelPermalink }}" class="talk-link">
                        {{ with .Params.image }}
                        <div class="talk-thumbnail-wrapper">
                            <img src="{{ . }}" alt="{{ $talk.Title }}" loading="lazy">
                            {{ with $talk.Params.event }}
                            <div class="talk-meta-box">
                                <div class="talk-event">{{ . }}</div>
                            </div>
                            {{ end }}
                        </div>
                        {{ end }}
                        <div class="talk-info">
                            <h3 class="talk-title">{{ $talk.Title }}</h3>
                        </div>
                    </a>
                </article>
            {{ end }}
        </div>
    </section>
    {{ end }}
</div>

<script>
(function() {
    const yearSections = document.querySelectorAll('.year-section');
    const yearLinks = document.querySelectorAll('.year-nav-link');

    function updateActiveYear() {
        let currentYear = null;
        const scrollPos = window.scrollY + 200;

        yearSections.forEach(section => {
            const top = section.offsetTop;
            const bottom = top + section.offsetHeight;
            if (scrollPos >= top && scrollPos < bottom) {
                currentYear = section.id.replace('year-', '');
            }
        });

        // Default to first year if at top of page
        if (!currentYear && yearSections.length > 0) {
            currentYear = yearSections[0].id.replace('year-', '');
        }

        yearLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#year-' + currentYear) {
                link.classList.add('active');
            }
        });
    }

    window.addEventListener('scroll', updateActiveYear);
    window.addEventListener('load', updateActiveYear);
    setTimeout(updateActiveYear, 100);
})();
</script>
{{ end }}
